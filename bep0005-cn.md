| 属性 | 值 |
| --- | --- |
| BEP编号 | 5 |
| 标题 | DHT协议 |
| 版本 | aa944d9e2faf989cbb4b1bad5ec130b9f22631d9 |
| 最后修改时间 | `2020年1月21日 15:59:05 -0800` |
| 作者 | Andrew Loewenstern <drue@bittorrent.com>, Arvid Norberg <arvid@bittorrent.com> |
| 状态 | 已采纳 |
| 类型 | 标准规范 |
| 创建时间 | 2008年1月31日 |
| 修订历史 | 2013年3月22日：在`announce_peer`消息中新增`implied_port`参数以优化NAT支持 |


BitTorrent使用一种"分布式松散哈希表"（DHT）来存储无追踪器（trackerless）种子的节点联系信息。实际上，每个节点都充当追踪器角色。本协议基于Kademlia架构[^1]，通过UDP协议实现。

为避免混淆，需特别注意本文档使用的术语定义：
- **"Peer"（对等节点）**：监听TCP端口并运行BitTorrent协议的客户端/服务器
- **"Node"（节点）**：监听UDP端口并运行分布式哈希表协议的客户端/服务器
- **DHT网络**：由节点构成，其存储Peer的位置信息。BitTorrent客户端内置DHT节点，用于与其他DHT节点通信以获取Peer位置，进而通过BitTorrent协议进行下载。

# 概述

每个节点拥有全局唯一的"节点ID"，节点ID从与BitTorrent信息哈希（infohash）一样从160位空间中随机选取[^2]。通过"距离度量"算法可比较两个节点ID或节点ID与信息哈希的"接近度"。
节点需维护包含少量其他节点联系信息的路由表，路由表对接近自身ID的区域记录更详细。

每个节点掌握大量在DHT网络中与自身ID"接近"的节点，但对远离自身ID的节点联系就很少。
Kademlia协议采用异或（XOR）来度量距离，结果视为无符号整数：`distance(A,B) = |A xor B|`，数值越小表示越接近。

当节点为下载某个种子而查找peer时，其会使用距离度量算法将种子的信息哈希与路由表中的节点ID进行比较，随后联系已知最接近该信息哈希的节点，询问其有关此种子的Peer联系信息。

若被询问节点知道该种子的peer联系信息，则回复这些Peer联系信息；否则，被询问节点需返回其路由表中最接近该信息哈希的节点联系信息。原始节点持续查询更接近目标信息哈希的节点，直至无法找到更近节点为止。查询完成后，客户端将自身的Peer联系信息插入到所有回复节点中离种子最近的那个节点上。

查询Peer的返回值包含称为"令牌"（token）的加密参数。
若一节点要宣告其控制的Peer正在下载某个种子，（与某一节点联系时）其必须提供从该被查询节点近期Peer查询中所获得的令牌。当节点尝试"宣告"（announce）种子时，被查询节点会校验令牌与查询发起节点的IP地址的匹配性，以防止恶意主机冒名注册。

由于令牌仅由查询节点返回至其颁发节点，实现方式未作强制规定。令牌需在颁发后的一段合理时间内保持有效。在BitTorrent中采用IP地址与每一个五分钟变化一次的密钥（secret）相拼接后的SHA1哈希值，可以接受在十分钟内的令牌。



# 路由表管理

每个节点维护包含已知良好节点的路由表。路由表中节点作为DHT查询的起始点。路由表中的节点来自于向其他节点请求时所收到的响应。

节点质量存在差异。部分节点为"良好"（good）节点，部分则不可靠。许多DHT节点能够发送查询并接收响应，但无法响应其他节点的查询请求。因此路由表必须仅包含已验证的可靠节点。符合以下条件之一即为良好节点：

1. 其在过去15分钟内响应过本节点查询
2. 其曾响应过本节点查询且在15分钟内发送过查询请求

若一节点15分钟无活动则转为"可疑"状态，连续多次查询无响应则标记为"不良"（bad）。已知的良好节点优先于未知状态节点。

路由表覆盖0至2¹⁶⁰的完整节点ID空间，划分为多个"存储桶"（bucket）分别管理部分空间。初始空表个单个存储桶，ID范围从 min=0至max=2¹⁶⁰。

当ID为"N"的节点插入路由表时，会被置于满足 min <= N < max 条件的存储桶中。初始空表仅有个存储桶，所有节点均归属其中。每个存储桶最多容纳K个节点（当前设定K=8），达到上限后视为"已满"。若存储桶已满且全为良好节点，则不再接受新节点，除非本节点ID属于该存储桶范围。此时原存储桶被拆分为两个新存储桶，每个新桶的范围是旧桶的一半，来自旧桶的节点会被重新分配到新桶中。对于初始单桶路由表，拆分后新桶的范围为0..2¹⁵⁹和2¹⁵⁹..2¹⁶⁰。

当存储桶已满且全为良好节点时，新节点将被直接丢弃。若桶内存在不良节点，则使用新节点对其进行替换。若存在超过15分钟未活动的可疑节点，则按"最长时间联系"的顺序发送ping探测。若被ping节点响应，则继续探测下一个可疑节点，直至发现无响应节点或确认全桶节点均为良好状态。对无响应的节点建议重试一次后再丢弃并替换为新节点，以此确保路由表中记录的均为长期稳定的节点。

每个存储桶包含"最后变更时间"（lastchange）字段以标识内容"新鲜度" 。当桶内节点响应ping、添加了新节点或旧节点被替换时，应更新此字段。
超过15分钟未变更的存储桶需执行"刷新"操作：在存储桶范围内随机选取一个ID执行find_nodes操作。通常能接收查询的节点无需频繁刷新，而无法接收查询的节点需定期刷新所有存储桶，确保需要使用DHT时路由表有状态良好的节点。

在首次向其路由表中插入节点以及在此之后启动时，该节点应尝试找到DHT网络中与自身最接近的节点。为此，其会通过向距离自己越来越近的节点发送 find_node 消息，不断寻找更近的节点，直到无法找到比当前更近的节点为止。此外，路由表应在客户端软件的每次运行之间进行保存，以便在下次启动时能够快速恢复路由信息。

# BitTorrent协议扩展

BitTorrent协议已扩展为 可在通过追踪器获取到的Peer之间交换节点的UDP端口号。这样一来，客户端在下载常规种子文件时可自动填充路由表。对于新安装的客户端来说，如果在首次尝试下载无tracker的种子文件时，它们的路由表中没有任何节点，因此需要依赖种子文件中包含的的节点信息。

支持DHT的Peer在BitTorrent协议握手阶段设置8字节保留标志的末位比特。收到支持DHT指示的Peer应发送PORT消息（以0x09字节开头，后接网络字节序的DHT节点UDP端口号）。接收方需尝试向该IP地址和端口发送ping请求，若获得响应则按常规规则尝试将新联系信息插入路由表。





支持 DHT 的对等节点会在 BitTorrent 协议握手过程中交换的 8 字节保留标志（reserved flags）中设置最后一个比特位。接收到握手信息的对等节点（表明远程对等节点支持 DHT）应发送一个 PORT 消息。该消息以字节 0x09 开头，包含一个两字节的有效载荷，其中携带 DHT 节点的 UDP 端口号（以网络字节顺序表示）。接收到此消息的对等节点应尝试根据接收到的端口号和远程对等节点的 IP 地址对其进行 ping 操作。如果收到了 ping 的响应，则该节点应根据常规规则尝试将新的联系信息插入其路由表中。


# 种子文件扩展

无追踪器种子字典不包含"announce"键，代之以"nodes"键。该键应设置为种子生成客户端路由表中K个最接近节点，或设置为已知良好节点（如种子发布者运营的节点）。请勿自动添加"router.bittorrent.com"到种子文件或客户端路由表。


```
nodes = [["<host>", <port>], ["<host>", <port>], ...]
nodes = [["127.0.0.1", 6881], ["your.router.node", 4804], ["2001:db8:100:0:d5c8:db3f:995e:c0f7", 1941]]
```

# KRPC协议

KRPC协议是通过UDP传输的B编码字典实现的简易RPC机制。采用单次查询-响应模式，无重试机制。包含三类消息：查询、响应、错误。DHT协议定义四种查询类型：ping、find_node、get_peers、announce_peer。

KRPC消息为包含三个公共键的字典，其他键依消息类型而定：
- **"t"**：事务ID字符串，由查询节点生成，响应中回显以匹配请求
- **"y"**：消息类型标识符（"q"=查询、"r"=响应、"e"=错误）
- **"v"**（可选）：客户端版本字符串，格式为BEP20[^3]注册的两个字符客户端标识符加两个字符版本号（因部分实现可能省略，客户端不应依赖此键）

## 联系信息编码

Peer联系信息编码为6字节字符串（紧凑IP-地址/端口信息）：4字节网络序IP地址 + 2字节网络序端口号。

节点联系信息编码为26字节字符串（紧凑节点信息）：20字节网络序节点ID + 紧凑IP-地址/端口信息。

## 查询消息

查询消息（y="q"）包含两个附加键：
- **"q"**：查询方法名称字符串
- **"a"**：包含查询参数的字典

## 响应消息

响应消息（y="r"）包含附加键"r"，值为包含返回参数的字典，表示查询成功完成。

## 错误消息

错误消息（y="e"）包含附加键"e"，值为列表：首元素为错误码整数，次元素为错误描述字符串。错误码定义如下：

| 代码 | 描述 |
| --- | --- |
| 201 | 通用错误 |
| 202 | 服务器错误 |
| 203 | 协议错误（如畸形数据包、无效参数或错误令牌） |
| 204 | 未知方法 |

错误报文示例：

```
generic error = {"t":"aa", "y":"e", "e":[201, "A Generic Error Ocurred"]}
bencoded = d1:eli201e23:A Generic Error Ocurrede1:t2:aa1:y1:ee
```

# DHT查询规范

所有查询包含查询节点的"id"键，所有响应包含响应节点的"id"键。

## ping查询

基础存活检测，方法名"ping"。
- **参数**：{"id": "查询节点20字节ID（网络序）"}
- **响应**：{"id": "响应节点20字节ID"}

示例报文：
